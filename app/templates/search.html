
{% extends "base.html" %}
{% block title %}RDDMS Admin — Search{% endblock %}

{% block content %}

<h2>Search</h2>

<!-- ✅ Working form -->
<form method="post" action="/search/run" style="marginrnedFields -->

  <div>
    <label>kind</label>
    <input name="kind" style="width:48rem"
           value="{{ kind or 'osdu:wks:work-product-component--ReservoirEstimatedVolumes:1.1.0' }}" />
  </div>

  <div>
    <label>query</label>
    <input name="query" style="width:48rem" value="{{ q or '*' }}" />
  </div>

  <div>
    <label>limit</label>
    <input name="limit" type="number" min="1" max="100" value="{{ limit or 5 }}" />
  </div>

  <div>
    <label>returnedFields (comma separated)</label>
    <input name="returnedFields" style="width:48rem"
           value="{{ returnedFields or 'id,kind,version,data.Name,data.Description,ancestry.parents,data.ParentObjectID' }}" />
  </div>

  <button type="submit">Search</button>
</form>

<!-- ✅ Error panel -->
{% if error %}
<div style="color:#b00020; background:#ffecec; border:1px solid #b00020; padding:.75rem; margin-bottom:1rem;">
  <strong>Error:</strong> {{ error }}<br>
  {% if error_detail %}
    <details style="margin-top:.5rem;">
      <summary>Details</summary>
      <pre style="white-space:pre-wrap;">{{ error_detail }}</pre>
    </details>
  {% endif %}
</div>
{% endif %}

<!-- ✅ Results -->
{% if results %}
  {% set total = results.totalCount or (results.results | length) %}
  <h3>Results ({{ total }})</h3>

  {% if total == 0 %}
    <p>No records matched your query.</p>
  {% else %}
    <table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse; width:100%;">
      <thead style="background:#f6f6f6;">
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Kind</th>
          <th>ID</th>
          <th>Version</th>
          <th>ParentObjectID</th>
          <th>Ancestors</th>
          <th>Children</th>
        </tr>
      </thead>
      <tbody>
      {% for rec in results.results or [] %}
        {% set name = (rec.data or {}).get('Name') %}
        {% set desc = (rec.data or {}).get('Description') %}
        {% set parentObj = (rec.data or {}).get('ParentObjectID') %}
        {% set ancestors = ((rec.ancestry or {}).get('parents') or []) %}
        {% set children = (children_by_id or {}).get(rec.id, []) %}
        <tr>
          <td>{{ name or '—' }}</td>
          <td>{{ desc or '—' }}</td>
          <td>{{ rec.kind or '—' }}</td>
          <td>{{ rec.id or '—' }}</td>
          <td>{{ rec.version if rec.version is not none else '—' }}</td>
          <td>{{ parentObj or '—' }}</td>
          <td>
            {% if ancestors %}
              <ul>{% for p in ancestors %}<li>{{ p }}</li>{% endfor %}</ul>
            {% else %}—{% endif %}
          </td>
          <td>
            {% if children %}
              <ul>{% for ch in children %}<li>{{ ch.id }} <small>({{ ch.kind }})</small></li>{% endfor %}</ul>
            {% else %}—{% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <h3 style="margin-top:2rem;">Relationship graphs (Mermaid)</h3>
    {% for rec in results.results or [] %}
      {% set name = (rec.data or {}).get('Name') %}
      {% set label = (name or rec.id or 'record') %}
      {% set ancestors = ((rec.ancestry or {}).get('parents') or []) %}
      {% set children = (children_by_id or {}).get(rec.id, []) %}
      {% set parentObj = (rec.data or {}).get('ParentObjectID') %}
      <h4>{{ label }}</h4>
      <pre class="mermaid">
graph LR
REC{{ loop.index }}["{{ label | replace('"','\\"') }}"]
{% if parentObj %}
POBJ{{ loop.index }}["{{ parentObj | replace('"','\\"') }}"] -->|context| REC{{ loop.index }}
{% endif %}
{% for p in ancestors %}
P{{ loop.index }}a{{ loop.index0 }}["{{ p | replace('"','\\"') }}"] -->|parent| REC{{ loop.index }}
{% endfor %}
{% for ch in children %}
C{{ loop.index }}c{{ loop.index0 }}["{{ (ch.id ~ ' (' ~ (ch.kind or '') ~ ')') | replace('"','\\"') }}"] -->|child| REC{{ loop.index }}
{% endfor %}
      </pre>
    {% endfor %}
    https://unpkg.com/mermaid@10.9.1/dist/mermaid.min.js</script>
    <script>mermaid.initialize({ startOnLoad: true });</script>
  {% endif %}
{% endif %}

<!-- Debug JSON -->
{% if results %}
  <details style="margin-top:1rem;">
    <summary>Debug: Raw Search JSON</summary>
    <pre style="white-space:pre-wrap;">{{ results | tojson(indent=2) }}</pre>
  </details>
{% endif %}

{% endblock %}
