{% extends "base.html" %}
{% block title %}RDDMS Admin â€” Home{% endblock %}

{% block content %}
  <h1>RDDMS Admin</h1>

  {% if dataspaces %}
    <h2>Dataspaces</h2>
    <ul id="ds-list">
      {% for ds_row in dataspaces %}
        {% set path = ds_row.get('path') if ds_row is mapping else ds_row %}
        <li data-path="{{ path }}">
          <code>{{ path }}</code>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No dataspaces found.</p>
  {% endif %}

  <hr />

  <script>
    // Build per-row actions after DOM is parsed.
    // We do NOT render <a> or <button> server-side to survive any HTML sanitizer.
    document.addEventListener('DOMContentLoaded', function () {
      const rows = document.querySelectorAll('#ds-list li[data-path]');
      rows.forEach(li => {
        const path = li.getAttribute('data-path') || '';

        // Remove any stray text nodes a sanitizer might have left
        li.childNodes.forEach(n => { if (n.nodeType === Node.TEXT_NODE) n.textContent = ''; });

        // Create [Open] button
        const openBtn = document.createElement('span');
        openBtn.className = 'btn';
        openBtn.textContent = 'Open';
        openBtn.title = `Open ${path}`;
        openBtn.style.marginRight = '8px';
        openBtn.addEventListener('click', () => {
          window.location.assign('/d/' + encodeURIComponent(path));
        });

        // Create [Keys] button, preselecting the dataspace via ?ds=...
        const keysBtn = document.createElement('span');
        keysBtn.className = 'btn';
        keysBtn.textContent = 'Keys';
        keysBtn.title = `Open Keys for ${path}`;
        keysBtn.style.marginRight = '8px';
        keysBtn.addEventListener('click', () => {
          window.location.assign('/keys?ds=' + encodeURIComponent(path));
        });

        // Insert actions before the <code>path</code>
        const codeNode = li.querySelector('code');
        li.insertBefore(keysBtn, codeNode);
        li.insertBefore(openBtn, codeNode);
        li.insertBefore(document.createTextNode(' '), codeNode);
      });
    });
  </script>
{% endblock %}
