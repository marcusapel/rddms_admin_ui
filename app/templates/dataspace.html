{% extends "base.html" %}
{% block title %}Dataspace — {{ ds }}{% endblock %}
{% block content %}

<style>
  .container { max-width: 1200px; margin: 1rem auto; padding: 0 1rem; }
  .cols { display: grid; grid-template-columns: 320px 1fr; gap: 1rem; align-items: start; }
  .card { border: 1px solid #e5e5e5; border-radius: 6px; padding: .75rem; background: #fff; }
  .muted { color: #666; }
  ul.types { list-style: none; padding-left: 0; margin: 0; }
  ul.types li { padding: .35rem .25rem; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; gap: 8px; align-items: center; }
  ul.types li a { text-decoration: none; }
  .count { background: #f2f2f2; border-radius: 4px; padding: 0 .4rem; color: #333; }
  .panel-header { display:flex; justify-content: space-between; align-items:center; gap:.5rem; }
  .spinner { display:none; }
  .spinner.show { display:inline-block; }
  .alert { padding: .6rem .8rem; border-radius: 6px; margin: .5rem 0; }
  .alert-danger { background: #fde8e8; border: 1px solid #f5c2c7; color: #842029; }
  code.badge { background: #f6f6f6; padding: .1rem .4rem; border-radius: 4px; }
</style>

<div class="container">
  <h2>Dataspace — <code class="badge">{{ ds }}</code></h2>

  <div class="cols">
    <div class="card">
      <h3>Types</h3>
      {% if types and types|length %}
        <ul class="types">
          {% for t in types %}
            {% set name = t.get('name') if t is mapping else t %}
            {% set count = t.get('count') if t is mapping else None %}
            <li>
              #{{ name }}</a>
              {% if count is not none %}<span class="count">{{ count }}</span>{% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No types found.</p>
      {% endif %}
    </div>

    <div class="card" id="panel">
      <div class="panel-header">
        <h3 id="panel-title">Resources</h3>
        <span id="panel-spin" class="spinner">Loading…</span>
      </div>
      <div id="panel-body" class="panel-body">
        <p class="muted">Select a type at left to list objects.</p>
      </div>
      <div id="panel-error" class="alert alert-danger" style="display:none"></div>
    </div>
  </div>
</div>

<script>
(function () {
  const panelTitle = document.getElementById('panel-title');
  const panelBody  = document.getElementById('panel-body');
  const panelErr   = document.getElementById('panel-error');
  const spin       = document.getElementById('panel-spin');

  function setError(msg) {
    panelErr.textContent = msg || 'Unknown error';
    panelErr.style.display = 'block';
  }
  function clearError() {
    panelErr.textContent = '';
    panelErr.style.display = 'none';
  }
  function showSpin(on) {
    spin.classList.toggle('show', !!on);
  }

  // Delegate clicks on the Types list
  document.addEventListener('click', async (ev) => {
    const a = ev.target.closest('a[data-typ]');
    if (!a) return;
    ev.preventDefault();
    const typ = a.getAttribute('data-typ');
    if (!typ) return;

    const ds = {{ ds | tojson }};
    panelTitle.textContent = `Resources — ${typ}`;
    clearError();
    showSpin(true);

    try {
      const url = `/d/${encodeURIComponent(ds)}/t/${encodeURIComponent(typ)}`;
      const res = await fetch(url, { headers: { 'Accept': 'text/html' } });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const html = await res.text();
      panelBody.innerHTML = html;
    } catch (e) {
      setError(String(e && e.message || e));
      panelBody.innerHTML = '<p class="muted">No content.</p>';
    } finally {
      showSpin(false);
    }
  });
})();
</script>

{% endblock %}